openapi: 3.1.0
info:
  title: Söz Ledger API
  version: 0.1.0
  description: AI Agent Trust Protocol — Track, verify, and score agent promises.
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api-production-c4c8.up.railway.app
    description: Production server
  - url: http://localhost:8000
    description: Local development server

security:
  - BearerAuth: []

paths:
  /:
    get:
      operationId: root
      summary: API root
      description: Returns basic API information.
      security: []
      responses:
        "200":
          description: API info
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                  version:
                    type: string
                  status:
                    type: string

  /health:
    get:
      operationId: healthCheck
      summary: Health check
      description: Returns the health status of the API.
      security: []
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /v1/entities:
    post:
      operationId: createEntity
      summary: Create a new entity
      description: Register an agent, human, or organization as a trust entity.
      tags:
        - Entities
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EntityCreate"
      responses:
        "201":
          description: Entity created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EntityResponse"
        "400":
          description: Invalid request body
        "401":
          description: Unauthorized

  /v1/entities/{entity_id}:
    get:
      operationId: getEntity
      summary: Get entity by ID
      description: Retrieve details of a registered entity.
      tags:
        - Entities
      parameters:
        - name: entity_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Entity details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EntityResponse"
        "401":
          description: Unauthorized
        "404":
          description: Entity not found

  /v1/entities/{entity_id}/score:
    get:
      operationId: getEntityScore
      summary: Get entity trust score
      description: Retrieve the current trust score for an entity.
      tags:
        - Entities
      parameters:
        - name: entity_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Trust score
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TrustScoreResponse"
        "401":
          description: Unauthorized
        "404":
          description: Entity not found

  /v1/promises:
    post:
      operationId: createPromise
      summary: Create a new promise
      description: Record a promise between two entities.
      tags:
        - Promises
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PromiseCreate"
      responses:
        "201":
          description: Promise created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PromiseResponse"
        "400":
          description: Invalid request body
        "401":
          description: Unauthorized
        "429":
          description: Anti-gaming limit exceeded

  /v1/promises/{promise_id}:
    get:
      operationId: getPromise
      summary: Get promise by ID
      description: Retrieve details of a recorded promise.
      tags:
        - Promises
      parameters:
        - name: promise_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Promise details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PromiseResponse"
        "401":
          description: Unauthorized
        "404":
          description: Promise not found

  /v1/promises/{promise_id}/status:
    patch:
      operationId: updatePromiseStatus
      summary: Update promise status
      description: Transition a promise to a new status (fulfilled, broken, or disputed).
      tags:
        - Promises
      parameters:
        - name: promise_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PromiseStatusUpdate"
      responses:
        "200":
          description: Status updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PromiseResponse"
        "400":
          description: Invalid status transition
        "401":
          description: Unauthorized
        "404":
          description: Promise not found
        "429":
          description: Fulfillment velocity limit exceeded

  /v1/promises/{promise_id}/evidence:
    post:
      operationId: submitEvidence
      summary: Submit evidence for a promise
      description: Attach evidence to a promise for verification.
      tags:
        - Evidence
      parameters:
        - name: promise_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EvidenceCreate"
      responses:
        "201":
          description: Evidence submitted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EvidenceResponse"
        "400":
          description: Invalid request body
        "401":
          description: Unauthorized
        "404":
          description: Promise not found
    get:
      operationId: listEvidence
      summary: List evidence for a promise
      description: Retrieve all evidence attached to a promise.
      tags:
        - Evidence
      parameters:
        - name: promise_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: List of evidence
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/EvidenceResponse"
        "401":
          description: Unauthorized
        "404":
          description: Promise not found

  /v1/scores/{entity_id}:
    get:
      operationId: getScore
      summary: Get trust score
      description: Retrieve the current trust score for an entity.
      tags:
        - Scores
      parameters:
        - name: entity_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Trust score
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TrustScoreResponse"
        "401":
          description: Unauthorized
        "404":
          description: Entity not found

  /v1/scores/{entity_id}/history:
    get:
      operationId: getScoreHistory
      summary: Get trust score history
      description: Retrieve the historical trust scores for an entity.
      tags:
        - Scores
      parameters:
        - name: entity_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 200
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        "200":
          description: Score history
          content:
            application/json:
              schema:
                type: object
                properties:
                  entity_id:
                    type: string
                    format: uuid
                  history:
                    type: array
                    items:
                      $ref: "#/components/schemas/TrustScoreSnapshot"
                  total:
                    type: integer
        "401":
          description: Unauthorized
        "404":
          description: Entity not found

  /v1/webhooks:
    post:
      operationId: createWebhook
      summary: Register a webhook
      description: Register a webhook URL to receive event notifications.
      tags:
        - Webhooks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WebhookCreate"
      responses:
        "201":
          description: Webhook created (includes secret — save it, shown only once)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebhookResponse"
        "400":
          description: Invalid request body
        "401":
          description: Unauthorized
    get:
      operationId: listWebhooks
      summary: List webhooks
      description: List all webhooks for the authenticated entity.
      tags:
        - Webhooks
      responses:
        "200":
          description: List of webhooks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/WebhookResponsePublic"
        "401":
          description: Unauthorized

  /v1/webhooks/{webhook_id}:
    get:
      operationId: getWebhook
      summary: Get webhook by ID
      description: Retrieve details of a registered webhook.
      tags:
        - Webhooks
      parameters:
        - name: webhook_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Webhook details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebhookResponsePublic"
        "401":
          description: Unauthorized
        "404":
          description: Webhook not found
    patch:
      operationId: updateWebhook
      summary: Update a webhook
      description: Update webhook URL, event types, or active status.
      tags:
        - Webhooks
      parameters:
        - name: webhook_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WebhookUpdate"
      responses:
        "200":
          description: Webhook updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebhookResponsePublic"
        "401":
          description: Unauthorized
        "404":
          description: Webhook not found
    delete:
      operationId: deleteWebhook
      summary: Delete a webhook
      description: Permanently delete a webhook registration.
      tags:
        - Webhooks
      parameters:
        - name: webhook_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Webhook deleted
        "401":
          description: Unauthorized
        "404":
          description: Webhook not found

  /v1/webhooks/{webhook_id}/logs:
    get:
      operationId: getWebhookLogs
      summary: Get webhook delivery logs
      description: Retrieve delivery attempt logs for a webhook (latest 100).
      tags:
        - Webhooks
      parameters:
        - name: webhook_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Delivery logs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/DeliveryLogResponse"
        "401":
          description: Unauthorized
        "404":
          description: Webhook not found

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: API key passed as a Bearer token in the Authorization header.

  schemas:
    EntityType:
      type: string
      enum:
        - agent
        - human
        - org

    PromiseCategory:
      type: string
      enum:
        - delivery
        - payment
        - response
        - uptime
        - custom

    PromiseStatus:
      type: string
      enum:
        - active
        - fulfilled
        - broken
        - expired
        - disputed

    EvidenceType:
      type: string
      enum:
        - api_callback
        - webhook
        - manual
        - file
        - link

    WebhookEventType:
      type: string
      enum:
        - promise.created
        - promise.fulfilled
        - promise.broken
        - promise.expired
        - score.updated
        - evidence.submitted

    EntityCreate:
      type: object
      required:
        - type
        - name
      properties:
        type:
          $ref: "#/components/schemas/EntityType"
        name:
          type: string
          minLength: 1
          maxLength: 256
        public_key:
          type:
            - string
            - "null"
        metadata:
          type:
            - object
            - "null"

    EntityResponse:
      type: object
      required:
        - id
        - type
        - name
        - created_at
      properties:
        id:
          type: string
          format: uuid
        type:
          $ref: "#/components/schemas/EntityType"
        name:
          type: string
        public_key:
          type:
            - string
            - "null"
        api_key:
          type:
            - string
            - "null"
          description: Only returned on entity creation.
        created_at:
          type: string
          format: date-time
        metadata:
          type:
            - object
            - "null"

    PromiseCreate:
      type: object
      required:
        - promisor_id
        - promisee_id
        - description
        - category
      properties:
        promisor_id:
          type: string
          format: uuid
        promisee_id:
          type: string
          format: uuid
        description:
          type: string
          minLength: 1
          maxLength: 1024
        deadline:
          type:
            - string
            - "null"
          format: date-time
        category:
          $ref: "#/components/schemas/PromiseCategory"

    PromiseResponse:
      type: object
      required:
        - id
        - promisor_id
        - promisee_id
        - description
        - category
        - status
        - created_at
      properties:
        id:
          type: string
          format: uuid
        promisor_id:
          type: string
          format: uuid
        promisee_id:
          type: string
          format: uuid
        description:
          type: string
        deadline:
          type:
            - string
            - "null"
          format: date-time
        category:
          $ref: "#/components/schemas/PromiseCategory"
        status:
          $ref: "#/components/schemas/PromiseStatus"
        created_at:
          type: string
          format: date-time
        fulfilled_at:
          type:
            - string
            - "null"
          format: date-time

    PromiseStatusUpdate:
      type: object
      required:
        - status
      properties:
        status:
          $ref: "#/components/schemas/PromiseStatus"

    EvidenceCreate:
      type: object
      required:
        - type
        - submitted_by
      properties:
        type:
          $ref: "#/components/schemas/EvidenceType"
        payload:
          type:
            - object
            - "null"
        submitted_by:
          type: string
          format: uuid

    EvidenceResponse:
      type: object
      required:
        - id
        - promise_id
        - type
        - submitted_by
        - verified
        - created_at
        - hash
      properties:
        id:
          type: string
          format: uuid
        promise_id:
          type: string
          format: uuid
        type:
          $ref: "#/components/schemas/EvidenceType"
        payload:
          type:
            - object
            - "null"
        submitted_by:
          type: string
          format: uuid
        verified:
          type: boolean
        created_at:
          type: string
          format: date-time
        hash:
          type: string
          description: SHA-256 hash of the evidence payload.

    TrustScoreResponse:
      type: object
      required:
        - entity_id
        - level
        - rated
        - total_promises
        - fulfilled_count
        - broken_count
        - avg_delay_hours
        - streak
        - score_version
      properties:
        entity_id:
          type: string
          format: uuid
        entity_name:
          type: string
        overall_score:
          type:
            - number
            - "null"
          minimum: 0
          maximum: 1
          description: Composite trust score between 0 and 1, or null if unrated.
        level:
          type: string
          description: "Human-readable trust level: Exceptional, Highly Trusted, Reliable, Developing, Low Trust, or Unrated."
        rated:
          type: boolean
          description: Whether the entity has enough history to be rated (minimum 5 promises).
        total_promises:
          type: integer
        fulfilled_count:
          type: integer
        broken_count:
          type: integer
        avg_delay_hours:
          type: number
          description: Average hours between deadline and fulfillment.
        category_scores:
          type:
            - object
            - "null"
          description: Per-category trust scores.
        streak:
          type: integer
          description: Current consecutive fulfilled-promise streak.
        score_version:
          type: string
          description: Version identifier of the scoring algorithm.
        last_updated:
          type:
            - string
            - "null"
          format: date-time

    TrustScoreSnapshot:
      type: object
      properties:
        score:
          type: number
        level:
          type: string
        total_promises:
          type: integer
        fulfilled_count:
          type: integer
        broken_count:
          type: integer
        streak:
          type: integer
        avg_delay_hours:
          type: number
        category_scores:
          type:
            - object
            - "null"
        score_version:
          type: string
        timestamp:
          type: string
          format: date-time

    WebhookCreate:
      type: object
      required:
        - url
        - event_types
      properties:
        url:
          type: string
          format: uri
        event_types:
          type: array
          items:
            $ref: "#/components/schemas/WebhookEventType"
          minItems: 1

    WebhookUpdate:
      type: object
      properties:
        url:
          type:
            - string
            - "null"
          format: uri
        event_types:
          type:
            - array
            - "null"
          items:
            $ref: "#/components/schemas/WebhookEventType"
        is_active:
          type:
            - boolean
            - "null"

    WebhookResponse:
      type: object
      required:
        - id
        - entity_id
        - url
        - secret
        - event_types
        - is_active
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
        entity_id:
          type: string
          format: uuid
        url:
          type: string
        secret:
          type: string
          description: HMAC signing secret. Only returned on creation.
        event_types:
          type: array
          items:
            $ref: "#/components/schemas/WebhookEventType"
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    WebhookResponsePublic:
      type: object
      required:
        - id
        - entity_id
        - url
        - event_types
        - is_active
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
        entity_id:
          type: string
          format: uuid
        url:
          type: string
        event_types:
          type: array
          items:
            $ref: "#/components/schemas/WebhookEventType"
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    DeliveryLogResponse:
      type: object
      required:
        - id
        - webhook_id
        - event_id
        - event_type
        - attempt_number
        - success
        - created_at
      properties:
        id:
          type: string
          format: uuid
        webhook_id:
          type: string
          format: uuid
        event_id:
          type: string
          format: uuid
        event_type:
          type: string
        attempt_number:
          type: integer
        status_code:
          type:
            - integer
            - "null"
        response_body:
          type:
            - string
            - "null"
        success:
          type: boolean
        error_message:
          type:
            - string
            - "null"
        next_retry_at:
          type:
            - string
            - "null"
          format: date-time
        created_at:
          type: string
          format: date-time

    WebhookPayload:
      type: object
      description: Payload delivered to webhook URLs. Signed with HMAC-SHA256.
      properties:
        event_type:
          $ref: "#/components/schemas/WebhookEventType"
        event_id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        data:
          type: object
          description: Event-specific data (promise, evidence, or score details).
